# Usage
Install dependencies
```
npm install
```
Run the script to insert data in the database for a specific country.
```
npm run insert [-- [--countries=RO] [--force] [--forceLookup] [--lookupTwice]]
```
If the data needed hasn't been downloaded and processed yet, the script will do the necessary steps before trying to connect to the database.

Create a new file named `.env` in the project root with db configuration, Google Maps api key, and zip codebase api key.

```
GOOGLE_MAPS_API_KEY=YOUR_API_KEY
ZIPCODEBASE_API_KEY=YOUR_API_KEY
DB_USER=postgres
DB_HOST=localhost
DB_DATABASE=location
DB_PASSWORD=postgres
DB_PORT=5432
```

# NPM scripts docs
### npm run download
---

1. try to download data from `geonames.org`
2. if 1 failed, try to download data from `zipcodebase.com` then

    2.1. get a list of all region codes for a country from the [iso3166 npm module](https://www.npmjs.com/package/iso-3166)

    2.2. make subsequent requests to zipcodebase.com/api/v1 to get all the zipcodes available for each region code
    
3. if 2 also failed, look for a module in the `fallback` folder than should export a `getEntries` method and `source` property with an url to the data source

4. create `data/${ countryCode }/raw.txt` file with the obtained data

### npm run geocode
---

1. parse `raw.txt`
2. make requests to the `maps.googleapis.com/maps/api/geocode/json` endpoint to improve the data. Events are sent in batches of 50, debounced with a delay of 1000ms to not exceed the API usage limit
    
    2.1. if `--forceLookup` is passed a request is made for every entry, otherwise, only for those missing data for the latitude or longitude fields

    2.2. if `--lookupTwice` is passed a second request is made based, but this time sending latitude and longitude as query arguments to improve data even more.

4. create `data/${ countryCode }/geocoded.txt` file with the new data

### npm run map
---
1. parse `geocoded.txt`
2. for each entry missing the `region_code` field look in the file `src/entry/mapping.js` where there are methods for each country code trying to infer the correct region code based on hand coded object maps.
4. create `data/${ countryCode }/processed.txt` file with the new data


### npm run sql
---
1. parse `processed.txt` and generate an sql insert statement with all the entries in the file
2. create `data/${ countryCode }/insert.sql` with the generated sql statement

### npm run deploy
---
1. parse `insert.sql` and read the query
2. read the connection configuration in `config/db.config.js`, connect to the database and run the query

### npm run process [-- [--deploy]]
---
Runs all the steps previously described stepts, except deploy, overwriting all of the previously generated files. Enabling the `--deploy` will make the script also deploy the data to the database once the processing is done.

### npm run readme
---
Generates an updated table with the data sources used for each country and adds it at the bottom of the document you're reading right now.

## Flags
`--countries=AD,AL...` comma delimited list of the country codes for the countries we need to run the scripts for

`--force` used to overwrite files previously generated by the same script

`--forceLookup` make Google Maps Geocoding API requests for all the entries regardless of the completeness of the available data

`--lookupTwice` make two requests to the Google Maps Geocoding API for each entry, for better data.

This is the case for a few countries like **Greece**, for which the command should be:

```
npm run geocode -- --countries=GR --forceLookup --lookupTwice
```