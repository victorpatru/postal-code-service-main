# Usage
Install dependencies
```
npm install
```
Run the script to insert data in the database for a specific country.
```
npm run insert [-- [--countries=RO] [--force] [--forceLookup] [--lookupTwice]]
```
If the data needed hasn't been downloaded and processed yet, the script will do the necessary steps before trying to connect to the database.

Create a new file named `.env` in the project root with db configuration, Google Maps api key, and zip codebase api key.

```
GOOGLE_MAPS_API_KEY=YOUR_API_KEY
ZIPCODEBASE_API_KEY=YOUR_API_KEY
DB_USER=postgres
DB_HOST=localhost
DB_DATABASE=location
DB_PASSWORD=postgres
DB_PORT=5432
```

# NPM scripts docs
### npm run download
---

1. try to download data from `geonames.org`
2. if 1 failed, try to download data from `zipcodebase.com` then

    2.1. get a list of all region codes for a country from the [iso3166 npm module](https://www.npmjs.com/package/iso-3166)

    2.2. make subsequent requests to zipcodebase.com/api/v1 to get all the zipcodes available for each region code
    
3. if 2 also failed, look for a module in the `fallback` folder than should export a `getEntries` method and `source` property with an url to the data source

4. create `data/${ countryCode }/raw.txt` file with the obtained data

### npm run geocode
---

1. parse `raw.txt`
2. make requests to the `maps.googleapis.com/maps/api/geocode/json` endpoint to improve the data. Events are sent in batches of 50, debounced with a delay of 1000ms to not exceed the API usage limit
    
    2.1. if `--forceLookup` is passed a request is made for every entry, otherwise, only for those missing data for the latitude or longitude fields

    2.2. if `--lookupTwice` is passed a second request is made based, but this time sending latitude and longitude as query arguments to improve data even more.

4. create `data/${ countryCode }/geocoded.txt` file with the new data

### npm run map
---
1. parse `geocoded.txt`
2. for each entry missing the `region_code` field look in the file `src/entry/mapping.js` where there are methods for each country code trying to infer the correct region code based on hand coded object maps.
4. create `data/${ countryCode }/processed.txt` file with the new data


### npm run sql
---
1. parse `processed.txt` and generate an sql insert statement with all the entries in the file
2. create `data/${ countryCode }/insert.sql` with the generated sql statement

### npm run deploy
---
1. parse `insert.sql` and read the query
2. read the connection configuration in `config/db.config.js`, connect to the database and run the query

### npm run process [-- [--deploy]]
---
Runs all the steps previously described stepts, except deploy, overwriting all of the previously generated files. Enabling the `--deploy` will make the script also deploy the data to the database once the processing is done.

### npm run readme
---
Generates an updated table with the data sources used for each country and adds it at the bottom of the document you're reading right now.

## Flags
`--countries=AD,AL...` comma delimited list of the country codes for the countries we need to run the scripts for

`--force` used to overwrite files previously generated by the same script

`--forceLookup` make Google Maps Geocoding API requests for all the entries regardless of the completeness of the available data

`--lookupTwice` make two requests to the Google Maps Geocoding API for each entry, for better data.

This is the case for a few countries like **Greece**, for which the command should be:

```
npm run geocode -- --countries=GR --forceLookup --lookupTwice
```
# Data Sources
| Country | Code | Data Source |
| --- | --- | --- |
| Andorra | AD | https://download.geonames.org/export/zip/AD.zip |
| Albania | AL | https://en.wikipedia.org/wiki/Postal_codes_in_Albania |
| Armenia | AM | https://arm.postcodebase.com/all |
| Austria | AT | https://download.geonames.org/export/zip/AT.zip |
| Bosnia and Herzegovina | BA | https://bih.postcodebase.com/all |
| Belgium | BE | https://download.geonames.org/export/zip/BE.zip |
| Bulgaria | BG | https://download.geonames.org/export/zip/BG.zip |
| Bahrain | BH | https://en.youbianku.com/Bahrain |
| Brazil | BR | https://download.geonames.org/export/zip/BR.zip |
| Belarus | BY | https://download.geonames.org/export/zip/BY.zip |
| Switzerland | CH | https://download.geonames.org/export/zip/CH.zip |
| Cyprus | CY | https://download.geonames.org/export/zip/CY.zip |
| Czechia | CZ | https://download.geonames.org/export/zip/CZ.zip |
| Germany | DE | https://download.geonames.org/export/zip/DE.zip |
| Denmark | DK | https://download.geonames.org/export/zip/DK.zip |
| Algeria | DZ | https://download.geonames.org/export/zip/DZ.zip |
| Estonia | EE | https://download.geonames.org/export/zip/EE.zip |
| Egypt | EG | https://zipcodebase.com |
| Egypt | EG2 | https://www.countryzipcode.com/egypt |
| Spain | ES | https://download.geonames.org/export/zip/ES.zip |
| Finland | FI | https://download.geonames.org/export/zip/FI.zip |
| France | FR | https://download.geonames.org/export/zip/FR.zip |
| United Kingdom | GB | https://download.geonames.org/export/zip/GB.zip |
| Georgia | GE | https://www.countryzipcode.com/georgia |
| Greece | GR | https://grc.postcodebase.com/all |
| Croatia | HR | https://download.geonames.org/export/zip/HR.zip |
| Hungary | HU | https://download.geonames.org/export/zip/HU.zip |
| Ireland | IE | https://download.geonames.org/export/zip/IE.zip |
| Italy | IT | https://download.geonames.org/export/zip/IT.zip |
| Liechtenstein | LI | https://download.geonames.org/export/zip/LI.zip |
| Lithuania | LT | https://download.geonames.org/export/zip/LT.zip |
| Luxembourg | LU | https://download.geonames.org/export/zip/LU.zip |
| Latvia | LV | https://download.geonames.org/export/zip/LV.zip |
| Libya | LY | NO DATA: Libya does not have zip codes |
| Morocco | MA | https://mar.postcodebase.com/all |
| Morocco | MA2 | https://www.countryzipcode.com/morocco |
| Monaco | MC | https://download.geonames.org/export/zip/MC.zip |
| Moldova | MD | https://download.geonames.org/export/zip/MD.zip |
| Montenegro | ME | https://zipcodebase.com |
| Montenegro | ME2 | https://www.countryzipcode.com/montenegro |
| North Macedonia | MK | https://download.geonames.org/export/zip/MK.zip |
| Malta | MT | https://download.geonames.org/export/zip/MT.zip |
| Mexico | MX | https://download.geonames.org/export/zip/MX.zip |
| Netherlands | NL | https://download.geonames.org/export/zip/NL.zip |
| Norway | NO | https://download.geonames.org/export/zip/NO.zip |
| Poland | PL | https://download.geonames.org/export/zip/PL.zip |
| Portugal | PT | https://download.geonames.org/export/zip/PT.zip |
| Romania | RO | https://download.geonames.org/export/zip/RO.zip |
| Serbia | RS | https://download.geonames.org/export/zip/RS.zip |
| Russia | RU | https://download.geonames.org/export/zip/RU.zip |
| Russia | RU2 | https://www.countryzipcode.com/russia |
| Sweden | SE | https://download.geonames.org/export/zip/SE.zip |
| Slovenia | SI | https://download.geonames.org/export/zip/SI.zip |
| Slovenia | SI2 | https://svn.postcodebase.com/all |
| Slovakia | SK | https://download.geonames.org/export/zip/SK.zip |
| San Marino | SM | https://download.geonames.org/export/zip/SM.zip |
| Tunisia | TN | https://zipcodebase.com |
| Tunisia | TN2 | https://www.countryzipcode.com/tunisia |
| Turkey | TR | https://download.geonames.org/export/zip/TR.zip |
| Ukraine | UA | https://download.geonames.org/export/zip/UA.zip |
| Vatican City | VA | https://download.geonames.org/export/zip/VA.zip |
| Kosovo | XK | https://postakosoves.com/en/zip-codes/ <br />Kosovo hasn't been assigned an official ISO 3166-1 alpha-2 code yet |

    